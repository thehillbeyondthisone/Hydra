<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Project Oracle ¬∑ Sonar Aggregator</title>
<style>
:root{
  --bg-main:#14181d; --bg-panel:#1f2329; --bg-input:#101216;
  --border-color:#333842; --text-primary:#d0d8e0; --text-secondary:#808a96; --text-muted:#5c6672;
  --accent-primary:#00aaff; --accent-secondary:#2a4c9b;
  --color-ok:#00c853; --color-err:#d50000; --color-warn:#ffab00; --color-info:#2aa7ff; --color-parse:#ff4081;
  --chat-team:#69f0ae; --chat-tell:#ff4081; --chat-system:#ffab00;
  --statusbar-h:126px; /* taller to include tools row */ --panel-h:360px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  background:var(--bg-main); color:var(--text-primary);
  font:14px/1.5 "Segoe UI",-apple-system,BlinkMacSystemFont,Roboto,"Helvetica Neue",sans-serif;
  margin:0; padding:16px;
}
.mono,pre{font-family:"Cascadia Code","Consolas","Courier New",monospace}

/* Layout */
.container-grid{display:grid;grid-template-columns:380px 1fr;gap:16px;height:calc(100vh - 32px - var(--statusbar-h))}
aside{display:flex;flex-direction:column;gap:16px;overflow:hidden}
main{overflow:hidden;display:flex;flex-direction:column}

/* Cards */
.card{background:var(--bg-panel);border:1px solid var(--border-color);border-radius:8px;padding:12px}
.card h3{margin:0 0 12px 0;font-size:16px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--text-primary);border-bottom:1px solid var(--border-color);padding-bottom:8px}
.row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.btn{background:#333842;color:var(--text-primary);border:1px solid #4a505a;padding:6px 12px;border-radius:6px;cursor:pointer;transition:.2s;font-size:13px;font-weight:500}
.btn:hover{background:#4a505a;border-color:var(--accent-primary)}
.btn.alt{background:var(--accent-secondary);border-color:transparent}
.input{background:var(--bg-input);color:var(--text-primary);border:1px solid var(--border-color);padding:6px 8px;border-radius:6px;width:100%}
.checkbox-row{display:inline-flex;align-items:center;gap:6px;cursor:pointer}
#sourcesList{flex-grow:1;overflow-y:auto;padding:2px}
.source-tile{background:var(--bg-input);padding:12px;border-radius:8px;margin-bottom:12px;border-left:4px solid var(--text-muted);transition:.3s;box-shadow:0 2px 4px rgba(0,0,0,.3)}
.source-tile.waiting{border-left-color:var(--color-warn)}
.source-tile.active{border-left-color:var(--color-ok)}
.source-tile .dropzone{height:50px;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;background:rgba(0,0,0,.3);border:2px dashed var(--border-color);border-radius:6px;padding:8px;transition:.2s;cursor:pointer;margin-top:8px;font-size:13px;color:var(--text-secondary)}
.source-tile .dropzone.linked{display:none}
.source-tile .dropzone.dragover,.source-tile .dropzone:hover{border-color:var(--accent-primary);background:#2c2c36}
.source-file-info{display:none}
.source-file-info.linked{display:block;background:rgba(0,0,0,.3);border:1px solid var(--border-color);border-radius:6px;padding:6px 8px;margin-top:8px}
.source-file-name{font-weight:500;font-size:12px;color:var(--text-secondary);word-break:break-all}
.source-status{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-secondary);margin-top:8px}
.source-footer{font-size:11px;color:var(--text-muted);margin-top:8px;display:flex;justify-content:space-between;align-items:center;gap:8px}

/* Small tile actions */
.tile-actions{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.tile-actions .btn{padding:4px 8px;font-size:12px}

/* Tabs */
.tab-nav{display:flex;gap:4px;margin-bottom:8px;border-bottom:1px solid var(--border-color);align-items:center}
.tab-btn{background:none;border:none;border-bottom:2px solid transparent;color:var(--text-secondary);padding:5px 10px;cursor:pointer;font-size:14px}
.tab-btn.active{color:var(--accent-primary);border-bottom-color:var(--accent-primary);font-weight:600}
.tab-pane{display:none;height:100%;overflow-y:auto}
.tab-pane.active{display:block}

/* Search bar */
.searchbar{margin-left:auto;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.searchbar input[type="text"]{min-width:220px}
.searchbar .meta{font-size:11px;color:var(--text-muted)}
.searchbar .seg{opacity:.6}
.help{border-bottom:1px dotted var(--text-secondary); cursor:help}

/* Chat */
.location-group{margin-bottom:16px}
.location-header{font-size:16px;font-weight:600;color:var(--accent-primary);border-bottom:1px solid var(--border-color);padding-bottom:6px;margin-bottom:8px;cursor:pointer;user-select:none}
.location-header::before{content:'‚ñº ';font-size:12px}
.location-group.collapsed .location-header::before{content:'‚ñ∫ '}
.location-group.collapsed .channel-container{display:none}
.channel-container{padding-left:8px;font-size:13px}
.chat-message{padding:1px 4px;line-height:1.6;word-wrap:break-word}
.chat-timestamp{color:var(--text-muted);font-size:11px;margin-right:8px}
.chat-channel{font-weight:600;margin:0 8px 0 2px}
.chat-sender{font-weight:600;margin-right:4px}
.channel-System .chat-content{color:var(--chat-system);font-style:italic}
.channel-Team .chat-channel{color:var(--chat-team)}
.channel-TellMessages .chat-channel{color:var(--chat-tell)}
.channel-TellMessages .chat-content{color:var(--chat-tell)}
mark.search-hit{background:#f9d36c;color:#111;padding:0 2px;border-radius:2px}

/* Footer (status + tools row + ticker) */
.statusbar{position:fixed;bottom:0;left:0;right:0;background:#101216;border-top:1px solid var(--border-color);font-size:12px;color:var(--text-secondary)}
.statusbar-top{display:flex;justify-content:space-between;align-items:center;padding:6px 16px}
.statusbar-tools{display:flex;justify-content:flex-end;gap:8px;padding:6px 16px;border-top:1px solid var(--border-color);border-bottom:1px solid var(--border-color);background:#0e141b}
.statusbar-ticker{background:rgba(0,170,255,.1);padding:6px 16px;overflow:hidden;white-space:nowrap;font-family:"Cascadia Code","Consolas","monospace";color:var(--accent-primary);position:relative}
.ticker-content{display:inline-block;min-width:300%;will-change:transform;animation:ticker 30s linear infinite}
@keyframes ticker{0%{transform:translateX(0)}100%{transform:translateX(-33.333%)}}
.pill{display:inline-block;padding:2px 8px;border-radius:12px;font-weight:600;font-size:11px;transition:.2s}
.pill.idle{background:#333842;color:#a0aab6}
.pill.active{background:var(--color-ok);color:#fff}
.pill.parsing{background:var(--color-parse);color:#fff;animation:pulse .5s}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}

/* Toasts */
.toast-container{position:fixed;right:16px;bottom:calc(var(--statusbar-h) + 12px);display:flex;flex-direction:column;gap:8px;z-index:9999;pointer-events:none}
.toast{background:#0e141b;border:1px solid var(--border-color);border-left:4px solid var(--color-info);color:var(--text-primary);padding:10px 12px;min-width:260px;max-width:420px;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,.45);transform:translateX(120%);opacity:0;transition:.35s ease;pointer-events:auto}
.toast.show{transform:translateX(0);opacity:1}
.toast .t-title{font-weight:700;margin-bottom:4px}
.toast .t-body{font-size:12px;color:var(--text-secondary)}
.toast[data-variant="success"]{border-left-color:var(--color-ok)}
.toast[data-variant="warn"]{border-left-color:var(--color-warn)}
.toast .t-actions{margin-top:8px;display:flex;gap:8px}
.toast .t-close{margin-left:auto;cursor:pointer;opacity:.8}
.toast .t-close:hover{opacity:1}

/* Tools row buttons */
.tool-btn{display:flex;align-items:center;gap:6px;height:34px;padding:0 12px;border-radius:8px;border:1px solid var(--border-color);background:#2a2f38;color:#ddd;cursor:pointer;font-size:12px}
.tool-btn:hover{filter:brightness(1.1)}
#btnDismissAllToolbar{display:none}

/* Panel */
.bottom-panel{
  position:fixed; left:0; right:0; bottom:var(--statusbar-h);
  height:var(--panel-h); background:var(--bg-panel); border-top:1px solid var(--border-color);
  transform:translateY(101%); transition:transform .28s ease, visibility 0s .28s;
  z-index:10002; display:flex; flex-direction:column; visibility:hidden; pointer-events:none;
}
.bottom-panel.open{transform:translateY(0); visibility:visible; transition:transform .28s ease; pointer-events:auto}
.bottom-panel-header{padding:10px 12px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between}
.bottom-panel-header h4{margin:0;font-size:14px;letter-spacing:.5px;text-transform:uppercase}
.bottom-panel-body{display:flex;flex-direction:column;gap:10px;padding:10px;height:100%}
.controls-row{
  display:flex; align-items:center; gap:14px; flex-wrap:wrap;
  padding:8px 10px; border:1px solid var(--border-color); border-radius:8px; background:var(--bg-input);
}
.controls-row .spacer{flex:1 1 auto}
.console-wrap{flex:1 1 auto; display:flex; min-height:0}
.console-box{background:#0b0f14;border:1px solid var(--border-color);border-radius:8px;padding:8px;height:100%;width:100%;overflow:auto}
.console-box pre{margin:0;color:var(--text-secondary)}

/* Buddy list chips */
.chips{display:flex;flex-wrap:wrap;gap:6px}
.chip{background:#2a2f38;border:1px solid var(--border-color);border-radius:16px;padding:2px 8px;font-size:12px;display:inline-flex;align-items:center;gap:6px}
.chip button{background:transparent;border:none;color:#bbb;cursor:pointer}
.chip button:hover{color:#fff}

/* Tooltip bubble */
.tooltip-bubble{
  position:fixed; max-width:320px; background:#0e141b; color:#d0d8e0; padding:8px 10px;
  border:1px solid var(--border-color); border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,.45);
  z-index:10005; font-size:12px; pointer-events:none;
}

/* Modals */
.modal-backdrop{
  position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:10020;
}
.modal{background:#1b2128; border:1px solid var(--border-color); border-radius:12px; padding:12px; width:min(720px,90vw); max-height:80vh; overflow:auto}
.modal h4{margin:0 0 8px 0; font-size:15px}
.modal .row{margin:8px 0}
.modal .list{border:1px solid var(--border-color); border-radius:8px; padding:8px; background:#0e141b; max-height:46vh; overflow:auto}
.saved-item{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px; border-bottom:1px dashed #2f3640}
.saved-item:last-child{border-bottom:0}
.path{font-family:"Cascadia Code","Consolas",monospace; color:#a7b3bf; font-size:12px; word-break:break-all}
</style>
</head>
<body>

<div class="container-grid">
  <aside>
    <div class="card" style="flex-shrink:0;">
      <h3>Global Filters</h3>
      <div id="globalFilterContainer" style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:12px;"></div>
    </div>

    <div class="card" style="display:flex;flex-direction:column;flex-grow:1;overflow:hidden;">
      <h3>Sensors</h3>
      <div id="sourcesList" style="min-height:120px;"></div>
      <div class="row" style="margin-top:12px;border-top:1px solid var(--border-color);padding-top:12px;flex-wrap:wrap">
        <button class="btn alt" id="btnAddSource">Deploy New Sensor</button>
        <button class="btn" id="btnReset">Reset System</button>
        <div class="spacer"></div>
        <button class="btn" id="btnSavedLogs">Saved Logs</button>
        <button class="btn" id="btnFindLogs">Log Finder</button>
      </div>
    </div>
  </aside>

  <main>
    <div class="card" style="flex-grow:1;overflow:hidden;display:flex;flex-direction:column;">
      <div class="tab-nav">
        <button class="tab-btn active" data-tab="chatPane">Aggregated Chat</button>
        <div class="searchbar">
          <input id="searchInput" class="input" type="text" placeholder="Search chat‚Ä¶ (regex optional)"/>
          <select id="searchChannel" class="input" style="max-width:140px;">
            <option value="">All channels</option>
            <option>Team</option>
            <option>Tell Messages</option>
            <option>System</option>
          </select>
          <label class="checkbox-row">
            <input type="checkbox" id="searchRegex">
            <span id="regexHelp" class="help">Regex</span>
          </label>
          <label class="checkbox-row"><input type="checkbox" id="searchCase"> Case</label>
          <label class="checkbox-row"><input type="checkbox" id="searchOnly"> Show only matches</label>
          <button class="btn" id="searchPrev" title="Previous match">‚ü®</button>
          <button class="btn" id="searchNext" title="Next match">‚ü©</button>
          <span class="meta"><span id="searchCount">0</span> matches <span class="seg">|</span> <span id="searchPos">‚Äî</span></span>
        </div>
      </div>

      <div id="chatPane" class="tab-pane active mono">
        <div id="chatDisplay" style="color:var(--text-secondary);height:100%;overflow:auto;">(Decrypted comms from active sensors will appear here)</div>
      </div>
    </div>
  </main>
</div>

<template id="sourceTileTemplate">
  <div class="source-tile">
    <div class="row" style="justify-content:space-between;margin-bottom:0;">
      <input type="text" class="input location-input" placeholder="Label this sensor..." style="font-weight:600;">
      <div class="tile-actions">
        <button class="btn btn-save" title="Save this log as a Saved Log">üíæ Save</button>
        <button class="btn btn-relink" title="Relink file if access is lost">üîó Relink</button>
        <button class="btn btn-remove" title="Decommission Sensor" aria-label="Decommission Sensor">‚úñ</button>
      </div>
    </div>
    <div class="dropzone" tabindex="0" role="button" aria-label="Attach log file">Drop log file or click to attach</div>
    <div class="source-file-info"><div class="source-file-name"></div></div>
    <div class="source-options">
      <label class="checkbox-row" title="Toggle system chatter for this sensor only">
        <input type="checkbox" class="show-system-msgs" checked> Show system messages
      </label>
    </div>
    <div class="source-status"><div class="dot"></div><div class="status-text">Awaiting log file...</div></div>
    <div class="source-footer">
      <span class="footer-time">Last update: ‚Äî</span>
      <div style="display:flex;gap:6px;align-items:center">
        <button class="btn btn-refresh" title="Reload last lines" aria-label="Reload last lines">‚ü≥</button>
      </div>
    </div>
  </div>
</template>

<!-- Bottom Drawer Panel -->
<aside class="bottom-panel" id="bottomPanel" aria-hidden="true">
  <div class="bottom-panel-header">
    <h4>Settings ‚Ä¢ Notifications ‚Ä¢ Console</h4>
    <div style="display:flex;gap:8px;align-items:center;">
      <button class="btn" id="btnDismissToasts">Dismiss all</button>
      <button class="btn" id="btnClosePanel">Close</button>
    </div>
  </div>
  <div class="bottom-panel-body">
    <div class="controls-row" id="controlsRow">
      <label class="checkbox-row"><input type="checkbox" id="toggleAutoscroll" checked> Auto-scroll</label>
      <span style="opacity:.6">‚Ä¢</span>
      <label class="checkbox-row"><input type="checkbox" id="globalShowSystem" checked> Show system messages (global)</label>
      <span style="opacity:.6">‚Ä¢</span>
      <label class="checkbox-row"><input type="checkbox" id="globalShowCombat"> Show combat messages</label>
      <span style="opacity:.6">‚Ä¢</span>
      <label class="checkbox-row"><input type="checkbox" id="notifyTeam"> Notify: Team</label>
      <label class="checkbox-row"><input type="checkbox" id="notifyTell"> Notify: Tell</label>
      <span style="opacity:.6">‚Ä¢</span>
      <label class="checkbox-row"><input type="checkbox" id="ruleTowers" checked> Tower Activity</label>
      <label class="checkbox-row"><input type="checkbox" id="ruleWorldBosses" checked> World Bosses (all)</label>
      <div class="spacer"></div>
      <span style="font-size:11px;color:var(--text-muted)">Applies to Chat & Console views.</span>
    </div>

    <!-- Buddy list -->
    <div class="controls-row">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;width:100%;">
        <strong style="font-size:12px;opacity:.85">Buddy list (Tell alerts):</strong>
        <input id="buddyInput" class="input" placeholder="Type a name and press Add" style="max-width:240px;">
        <button class="btn" id="buddyAddBtn">Add</button>
        <div id="buddyChips" class="chips"></div>
      </div>
    </div>

    <div class="console-wrap">
      <div class="console-box" id="consoleBox"><pre id="consolePre">(Raw log lines will appear here)</pre></div>
    </div>
  </div>
</aside>

<!-- Footer -->
<div class="statusbar">
  <div class="statusbar-top">
    <div><strong>Project Oracle</strong> ‚Äî <span id="modeLabel">SYSTEM IDLE</span></div>
    <div style="display:flex;align-items:center;gap:8px;">
      <span class="pill idle" id="parsingIndicator">IDLE</span>
      <span id="statusMetrics" class="mono"></span>
    </div>
    <div>Last Check: <span id="lastCheckLabel">‚Äî</span> ‚Ä¢ Local: <span id="clockLocal"></span> ‚Ä¢ UTC: <span id="clockUTC"></span></div>
  </div>

  <!-- Tools row (always above ticker, right-aligned) -->
  <div class="statusbar-tools">
    <button class="tool-btn" id="btnOpenPanel" title="Open settings panel">‚öôÔ∏è <span>Settings</span></button>
    <button class="tool-btn" id="btnDismissAllToolbar" title="Dismiss all notifications">‚úñ <span>Dismiss all</span></button>
  </div>

  <div class="statusbar-ticker">
    <div class="ticker-content" id="tickerContent"><span>‚öîÔ∏è Monitoring battlefield communications... ‚Ä¢ ‚öîÔ∏è Monitoring battlefield communications... ‚Ä¢ ‚öîÔ∏è Monitoring battlefield communications...</span></div>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<!-- Saved Logs Modal -->
<div class="modal-backdrop" id="savedModal">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h4>Saved Logs</h4>
      <button class="btn" id="savedClose">Close</button>
    </div>
    <div class="row">
      <div class="list" id="savedList"></div>
    </div>
    <div class="row" style="display:flex;gap:8px;align-items:center;">
      <input id="savedNewLabel" class="input" placeholder="Label for new saved log (when saving from a tile)" style="max-width:260px;" disabled>
      <button class="btn" id="savedPurge">Delete all saved</button>
    </div>
  </div>
</div>

<!-- Log Finder Modal -->
<div class="modal-backdrop" id="finderModal">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h4>Log Finder</h4>
      <button class="btn" id="finderClose">Close</button>
    </div>
    <p style="margin:6px 0 10px 0; color:#aab4bf">Pick your Anarchy Online chat log. Try the path below on Windows, or click ‚ÄúBrowse‚Ä¶‚Äù</p>
    <div class="row">
      <div class="path">C:\Users\Administrator\AppData\Local\Funcom\Anarchy Online\9486bac5\Anarchy Online\Prefs\linusdavidson\Char1892400290\Chat\Windows\Window6\Log.txt</div>
    </div>
    <div class="row" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <button class="btn" id="finderBrowse">üìÇ Browse‚Ä¶</button>
      <input type="file" id="finderFile" style="display:none" />
      <span style="font-size:12px;color:#8ea0b3">Tip: the active log is usually in the <em>Windows/WindowX</em> subfolder.</span>
    </div>
  </div>
</div>

<script>
(function(){
  /* ===== Small helpers ===== */
  const kb=n=>n*1024, now=()=>new Date(), nowMs=()=>Date.now();
  const fmtLocal=()=>now().toLocaleTimeString();
  const fmtUTC=()=>now().toUTCString().match(/\d{2}:\d{2}:\d{2}/)?.[0]||now().toUTCString();
  const fmtNum=n=>n.toLocaleString();
  const qs=s=>document.querySelector(s);
  const supportsFS = 'showOpenFilePicker' in window && 'indexedDB' in window;

  function toastErr(msg){ Toasts.push({title:'Error', body:String(msg).slice(0,180), variant:'warn'}); }

  function sanitizeChatMarkup(raw){
    if (!raw) return '';
    const nl = raw.replace(/<br\s*\/?>/gi, '\n');
    const div = document.createElement('div');
    div.innerHTML = nl;
    let txt = div.textContent || div.innerText || '';
    txt = txt.replace(/\r/g,'').replace(/[ \t\f\v]+/g,' ').replace(/\n{3,}/g,'\n\n').trim();
    return txt;
  }

  /* ===== Tooltip ===== */
  function attachTooltip(el, text){
    let bubble=null;
    function show(e){
      bubble=document.createElement('div'); bubble.className='tooltip-bubble'; bubble.textContent=text;
      document.body.appendChild(bubble); position(e);
    }
    function position(e){
      if(!bubble) return;
      const pad=10;
      let x=e.clientX+12, y=e.clientY+16;
      const bw=bubble.offsetWidth, bh=bubble.offsetHeight;
      const vw=window.innerWidth, vh=window.innerHeight;
      if(x+bw+pad>vw) x = vw - bw - pad;
      if(y+bh+pad>vh) y = vh - bh - pad;
      bubble.style.left=`${x}px`; bubble.style.top=`${y}px`;
    }
    function hide(){ if(bubble){ bubble.remove(); bubble=null; } }
    el.addEventListener('mouseenter',show);
    el.addEventListener('mousemove',position);
    el.addEventListener('mouseleave',hide);
    el.addEventListener('blur',hide);
  }

  /* ===== Toasts ===== */
  const toastContainer=document.getElementById('toastContainer');
  const btnDismissAllToolbar=document.getElementById('btnDismissAllToolbar');
  function updateDismissToolbar(){
    const n = toastContainer.children.length;
    btnDismissAllToolbar.style.display = n >= 2 ? 'flex' : 'none';
  }
  const Toasts=(()=>{
    function push({title='Notice',body='',variant='info',timeout=0}={}){
      const el=document.createElement('div'); el.className='toast'; el.dataset.variant=variant;
      el.innerHTML='<div class="t-title"></div><div class="t-body"></div><div class="t-actions"><span class="t-close" title="Dismiss">‚úñ</span></div>';
      el.querySelector('.t-title').textContent=title; el.querySelector('.t-body').textContent=body;
      el.querySelector('.t-close').onclick=()=>dismiss(el);
      toastContainer.appendChild(el); requestAnimationFrame(()=>el.classList.add('show'));
      if(timeout>0) setTimeout(()=>dismiss(el),timeout);
      updateDismissToolbar();
      return el;
    }
    function dismiss(el){
      if(!el) return; el.classList.remove('show');
      el.addEventListener('transitionend',()=>{ el.remove(); updateDismissToolbar(); },{once:true});
    }
    function dismissAll(){
      [...toastContainer.children].forEach(dismiss);
      updateDismissToolbar();
    }
    return { push, dismiss, dismissAll };
  })();

  /* ===== DOM refs ===== */
  const btnAddSource=qs('#btnAddSource'), btnReset=qs('#btnReset'), sourcesList=qs('#sourcesList'), sourceTileTemplate=qs('#sourceTileTemplate');
  const chatDisplay=qs('#chatDisplay'), modeLabel=qs('#modeLabel'), statusMetrics=qs('#statusMetrics'), lastCheckLabel=qs('#lastCheckLabel'), parsingIndicator=qs('#parsingIndicator');
  const globalFilterContainer=qs('#globalFilterContainer');

  const bottomPanel=qs('#bottomPanel'), btnOpenPanel=qs('#btnOpenPanel'), btnClosePanel=qs('#btnClosePanel'), btnDismissToasts=qs('#btnDismissToasts');
  const btnSavedLogs=qs('#btnSavedLogs'), btnFindLogs=qs('#btnFindLogs');

  const autoscrollToggle=qs('#toggleAutoscroll'), notifyTeam=qs('#notifyTeam'), notifyTell=qs('#notifyTell'), ruleTowers=qs('#ruleTowers'), ruleWorldBosses=qs('#ruleWorldBosses');
  const globalShowSystemEl=qs('#globalShowSystem'), globalShowCombatEl=qs('#globalShowCombat');

  const buddyInput=qs('#buddyInput'), buddyAddBtn=qs('#buddyAddBtn'), buddyChips=qs('#buddyChips');

  const searchInput=qs('#searchInput'), searchRegex=qs('#searchRegex'), searchCase=qs('#searchCase'), searchOnly=qs('#searchOnly'), searchPrev=qs('#searchPrev'), searchNext=qs('#searchNext'), searchChannel=qs('#searchChannel');
  const searchCountEl=qs('#searchCount'), searchPosEl=qs('#searchPos'), regexHelp=qs('#regexHelp');

  const consoleBox=qs('#consoleBox'), consolePre=qs('#consolePre');
  const clockLocal=qs('#clockLocal'), clockUTC=qs('#clockUTC');
  const tickerEl=qs('#tickerContent');

  /* Saved Logs modal */
  const savedModal=qs('#savedModal'), savedClose=qs('#savedClose'), savedList=qs('#savedList'), savedPurge=qs('#savedPurge');

  /* Finder modal */
  const finderModal=qs('#finderModal'), finderClose=qs('#finderClose'), finderBrowse=qs('#finderBrowse'), finderFile=qs('#finderFile');

  /* ===== State ===== */
  const sources={}; let linesRead=0, tileCounter=0;
  const MAX_LOG_LINES=500, recentLinesCache=new Set(), CACHE_SIZE=200;
  const activeChannels=new Set(), globalFilters={};
  const tickerData={ lastTowerBattle:null, lastLevel220:null, lastAI30:null, lastWorldBoss:null };
  const channelNotify={ 'Team':false, 'Tell Messages':false };
  let autoScroll=true, globalShowSystem=true, globalShowCombat=false;

  // Search state
  const currentSearch={ query:'', regex:false, cs:false, only:false, channel:'', matcher:null };
  let matchRefs=[]; let matchIndex=-1;

  // Buddy list
  const buddies=new Set();
  function addBuddy(name){ const n=(name||'').trim(); if(!n) return; const key=n.toLowerCase(); if(buddies.has(key)) return; buddies.add(key); renderBuddies(); }
  function removeBuddy(key){ buddies.delete(key); renderBuddies(); }
  function renderBuddies(){
    buddyChips.textContent='';
    buddies.forEach(key=>{
      const chip=document.createElement('span'); chip.className='chip';
      chip.innerHTML=`<span>${key}</span><button title="Remove">‚úñ</button>`;
      chip.querySelector('button').addEventListener('click',()=>removeBuddy(key));
      buddyChips.appendChild(chip);
    });
  }

  /* ===== Tooltip ===== */
  attachTooltip(regexHelp, "‚ÄòRegex‚Äô = advanced pattern matching. Example: ^Tarasque|Dark matches messages starting with ‚ÄòTarasque‚Äô or containing ‚ÄòDark‚Äô. Leave it off for normal search.");

  /* ===== Footer clocks ===== */
  function updateClocks(){ clockLocal.textContent=fmtLocal(); clockUTC.textContent=fmtUTC(); }
  setInterval(updateClocks, 1000); updateClocks();

  /* ===== Ticker ===== */
  let lastTickerStr='';
  function minutesAgo(ts){
    if(!ts) return '';
    const m = Math.floor((nowMs()-ts)/60000);
    if(m<=0) return 'just now';
    if(m===1) return '1 min ago';
    return `${m} mins ago`;
  }
  function tickerItems(){
    const items=[];
    items.push(`üïí Local ${fmtLocal()}`);
    items.push(`üïò UTC ${fmtUTC()}`);
    const sensorCount=Object.keys(sources).length;
    items.push(`üì° ${sensorCount} sensor${sensorCount!==1?'s':''}`);
    items.push(`#Ô∏è‚É£ ${activeChannels.size} channels`);
    items.push(`üìà ${fmtNum(linesRead)} lines`);
    if(tickerData.lastWorldBoss){ items.push(`üêâ ${tickerData.lastWorldBoss.text} (${minutesAgo(tickerData.lastWorldBoss.ts)})`); }
    if(tickerData.lastTowerBattle) items.push(`‚öîÔ∏è ${tickerData.lastTowerBattle}`);
    if(tickerData.lastLevel220) items.push(`‚≠ê ${tickerData.lastLevel220}`);
    if(tickerData.lastAI30) items.push(`üèÜ ${tickerData.lastAI30}`);
    return items;
  }
  function setTicker(items){
    const content=(items.length?items:['‚öîÔ∏è Monitoring battlefield communications...']).join(' ‚Ä¢ ');
    const str=`${content} ‚Ä¢ ${content} ‚Ä¢ ${content}`;
    if(str===lastTickerStr) return;
    lastTickerStr=str; tickerEl.textContent=''; const span=document.createElement('span'); span.textContent=str; tickerEl.appendChild(span);
  }
  setInterval(()=>setTicker(tickerItems()), 15000); setTicker(tickerItems());

  /* ===== Console buffer ===== */
  const pushToConsole=(()=>{const buf=[];return(line)=>{
    if(consolePre.textContent.startsWith('('))consolePre.textContent='';
    buf.push(line); if(buf.length>MAX_LOG_LINES)buf.shift();
    const near=consoleBox.scrollHeight-consoleBox.clientHeight<=consoleBox.scrollTop+20;
    const should=autoScroll?true:near;
    consolePre.textContent=buf.join('\n');
    if(should)consoleBox.scrollTop=consoleBox.scrollHeight;
  };})();

  /* ===== System-like & Combat filters ===== */
  const sysPatts=[/changing area/i,/entering '/i,/team side is/i,/kicked from the team/i,/joined the team/i,/left the team/i,/you are now in/i,/welcome to/i,/you were healed/i,/attacked by/i,/nanoprogram/i];
  function isSystemLike(channel,sender,message,parseFailed=false){
    if(parseFailed)return true; if(!sender)return true; if((channel||'').trim().toLowerCase()==='system')return true;
    for(let i=0;i<sysPatts.length;i++){ if(sysPatts[i].test(message||'')) return true; }
    return false;
  }

  const combatPatts = [
    /\b(?:skill )?available\.$/i,
    /you successfully perf?orm(?:ed)?/i,
    /wait for your previous special attack/i,
    /chaos ritual/i,
    /opportunist available/i,
    /totemic rites available/i,
    /piercing mastery available/i,
    /spirit phylactery available/i,
    /dimensional fist attack/i,
    /hecatomb attack/i,
    /gore attack/i,
    /capture spirit attack/i,
    /unsealed (pestilence|contagion)/i
  ];
  function isCombatMessage(channel, message){
    if((channel||'').toLowerCase()!=='system') return false;
    const m = message || '';
    for(let i=0;i<combatPatts.length;i++){ if(combatPatts[i].test(m)) return true; }
    return false;
  }

  /* ===== Chat helpers ===== */
  function buildChatMessageEl({time,channel,sender,message,channelColor,isSystemMsg,sourceId}){
    const d=document.createElement('div'); d.className='chat-message channel-'+channel.replace(/[^a-zA-Z0-9]/g,''); d.dataset.channel=channel; d.dataset.isSystemMsg=isSystemMsg?'true':'false'; d.dataset.sourceId=sourceId||'';
    const ts=document.createElement('span'); ts.className='chat-timestamp'; ts.textContent=time;
    const ch=document.createElement('span'); ch.className='chat-channel'; ch.textContent=`[${channel}]`; if(channelColor) ch.style.color=channelColor;
    const snd=document.createElement('span'); snd.className='chat-sender'; if(sender) snd.textContent=`${sender}:`;
    const ct=document.createElement('span'); ct.className='chat-content';
    ct.textContent=sanitizeChatMarkup(message);
    ct.dataset.raw = ct.textContent;
    d.appendChild(ts); d.appendChild(document.createTextNode(' '));
    if(sender){ d.appendChild(ch); d.appendChild(snd); d.appendChild(document.createTextNode(' ')); }
    d.appendChild(ct); return d;
  }
  function getTileSystemToggle(sourceId){const src=sources[sourceId]; if(!src)return true; const cb=src.elem.querySelector('.show-system-msgs'); return !!(cb&&cb.checked)}

  /* ===== Render message ===== */
  function addChatMessage(location,data){
    if(!location)location='Uncategorized';
    const locationId='loc-'+location.replace(/[^a-zA-Z0-9]/g,'');
    let group=document.getElementById(locationId);
    if(!group){
      if(chatDisplay && chatDisplay.firstElementChild && chatDisplay.childElementCount===1){
        const only=chatDisplay.firstElementChild; if(only && only.textContent.includes('Decrypted comms')) chatDisplay.textContent='';
      }
      group=document.createElement('div'); group.id=locationId; group.className='location-group';
      const header=document.createElement('div'); header.className='location-header'; header.textContent=location; header.onclick=()=>group.classList.toggle('collapsed');
      const container=document.createElement('div'); container.className='channel-container';
      group.appendChild(header); group.appendChild(container); chatDisplay.appendChild(group);
    }
    const container=group.querySelector('.channel-container');
    const el=buildChatMessageEl(data);

    const isCombat = isCombatMessage(data.channel, data.message);
    el.dataset.isCombat = isCombat ? 'true' : 'false';

    const allowSys=getTileSystemToggle(data.sourceId);
    const showByGlobal =
      globalFilters[data.channel] !== false &&
      (!data.isSystemMsg || (allowSys && globalShowSystem)) &&
      (!(isCombat) || globalShowCombat);

    el.style.display = showByGlobal ? '' : 'none';

    enqueueAppend(container, el);

    if(currentSearch.only && currentSearch.matcher){
      const ok = quickMatch(el, currentSearch.matcher, currentSearch.regex, currentSearch.cs, currentSearch.channel);
      el.style.display = ok ? '' : 'none';
      if(ok){ renderHighlightsInto(el.querySelector('.chat-content'), currentSearch.matcher, currentSearch.regex, currentSearch.cs); }
    }
  }

  function applyGlobalFilters(){
    document.querySelectorAll('.chat-message').forEach(msg=>{
      const channel=msg.dataset.channel;
      const isSys=(msg.dataset.isSystemMsg==='true')||channel==='System'||!msg.querySelector('.chat-sender');
      const allowSysTile=getTileSystemToggle(msg.dataset.sourceId);
      const showChannel = globalFilters[channel]!==false;
      const showSys = globalShowSystem && allowSysTile;
      const isCombat = msg.dataset.isCombat === 'true';
      const showCombat = !isCombat || globalShowCombat;
      msg.style.display=(showChannel && (!isSys || showSys) && showCombat)?'':'none';
    });
  }
  function rebuildChannelUIs(){
    globalFilterContainer.textContent=''; const sorted=[...activeChannels].sort();
    const known={'Team':'var(--chat-team)','Tell Messages':'var(--chat-tell)','System':'var(--chat-system)'}; const unknown=['#ab47bc','#ff6b6b','#4ecdc4','#ffe66d','#a8dadc','#f1a7fe','#95e1d3']; let i=0;
    sorted.forEach(channel=>{
      if(globalFilters[channel]===undefined) globalFilters[channel]=true;
      const lab=document.createElement('label'); lab.className='checkbox-row';
      const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=globalFilters[channel];
      cb.addEventListener('change',()=>{globalFilters[channel]=cb.checked;applyGlobalFilters(); if(currentSearch.query) applySearch(true);});
      const span=document.createElement('span'); span.textContent=channel; span.style.color=known[channel]||unknown[i++%unknown.length];
      lab.appendChild(cb); lab.appendChild(span); globalFilterContainer.appendChild(lab);
    });
  }

  /* ===== Sensors & Tail ===== */
  const MAX_INITIAL_LINES = 200;

  async function readLastLinesFromFile(file, maxLines=MAX_INITIAL_LINES){
    const CHUNK = kb(64);
    let pos = file.size;
    let buffer = '';
    let lines = [];

    while(pos > 0 && lines.length <= maxLines){
      const start = Math.max(0, pos - CHUNK);
      const slice = await file.slice(start, pos).text();
      buffer = slice + buffer;
      const parts = buffer.split(/\r?\n/);
      buffer = parts.shift();
      lines = parts.concat(lines);
      pos = start;
    }
    if(buffer) lines.unshift(buffer);
    return lines.filter(Boolean).slice(-maxLines);
  }

  function createSourceTile(){
    tileCounter++; const id='sensor-'+tileCounter;
    const tile=sourceTileTemplate.content.cloneNode(true).firstElementChild; tile.dataset.sourceId=id; sourcesList.appendChild(tile);
    sources[id]={id,elem:tile,file:null,fileHandle:null,offset:0,timerId:null,isReading:false,live:false,label:''};

    tile.querySelector('.status-text').textContent='Awaiting log file...'; tile.classList.add('waiting');
    const dropzone=tile.querySelector('.dropzone'); const fileInput=document.createElement('input'); fileInput.type='file';
    const onFileDrop=async(file,handle=null)=>{
      if(sources[id].file) return; await addFileToSource(id,file,handle);
      dropzone.classList.add('linked'); tile.querySelector('.source-file-info').classList.add('linked');
    };
    fileInput.onchange=()=>{if(fileInput.files[0]) onFileDrop(fileInput.files[0],null)};
    dropzone.addEventListener('click',()=>fileInput.click());
    dropzone.addEventListener('keydown',e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();fileInput.click();}});
    ['dragover','dragleave','drop'].forEach(ev=>dropzone.addEventListener(ev,async e=>{
      e.preventDefault(); if(ev==='dragover')dropzone.classList.add('dragover'); else dropzone.classList.remove('dragover');
      if(ev==='drop'&&e.dataTransfer?.items?.length){let file=null,handle=null;const item=e.dataTransfer.items[0];
        if('getAsFileSystemHandle' in item){try{const h=await item.getAsFileSystemHandle(); if(h&&h.kind==='file'){handle=h; file=await h.getFile();}}catch{}}
        if(!file&&e.dataTransfer.files.length) file=e.dataTransfer.files[0]; if(file) onFileDrop(file,handle);
      }
    }));
    tile.querySelector('.btn-remove').onclick=()=>removeSource(id);
    tile.querySelector('.btn-refresh').onclick=()=>loadLastLines(id,{forceScroll:true,updateTickerNow:true});
    tile.querySelector('.btn-relink').onclick=async()=>{ const handle = await pickFileHandle(); if(handle){ const f=await handle.getFile(); await addFileToSource(id,f,handle); } };
    tile.querySelector('.btn-save').onclick=()=>saveTileToDB(id);
    tile.querySelector('.show-system-msgs').addEventListener('change',()=>{applyTileSystemFilter(id); if(currentSearch.query) applySearch(true);});
    tile.querySelector('.location-input').addEventListener('input',e=>{ sources[id].label = e.target.value.trim(); });
  }

  function applyTileSystemFilter(sourceId){
    const allowSys=getTileSystemToggle(sourceId);
    document.querySelectorAll('.chat-message').forEach(msg=>{
      if(msg.dataset.sourceId===sourceId){
        const isSys=(msg.dataset.isSystemMsg==='true')||msg.dataset.channel==='System'||!msg.querySelector('.chat-sender');
        const showChannel = globalFilters[msg.dataset.channel]!==false;
        const showSys = globalShowSystem && allowSys;
        const isCombat = msg.dataset.isCombat === 'true';
        const showCombat = !isCombat || globalShowCombat;
        msg.style.display=(showChannel && (!isSys || showSys) && showCombat)?'':'none';
      }
    });
  }

  async function addFileToSource(id,file,handle=null){
    const s=sources[id]; s.file=file; s.fileHandle=handle; s.live=!!handle; s.offset=file.size;
    const el=s.elem; el.classList.remove('waiting'); el.classList.add('active');
    el.querySelector('.source-file-name').textContent=`Linked: ${file.name}`;
    el.querySelector('.status-text').textContent=s.live?'Tailing (Live)':'Static file (use Refresh)';
    el.querySelector('.footer-time').textContent='Last update: '+fmtLocal();

    await loadLastLines(id,{forceScroll:true,updateTickerNow:true});
    if(s.live) startTailingForSource(id);
  }

  function removeSource(id){
    const s=sources[id]; if(!s) return; s.isReading=false; if(s.timerId) clearInterval(s.timerId);
    s.elem.remove(); delete sources[id]; const n=Object.keys(sources).length;
    if(n===0){modeLabel.textContent='SYSTEM IDLE'; parsingIndicator.className='pill idle'; parsingIndicator.textContent='IDLE'}
    statusMetrics.textContent=`${n} sensor(s) | ${fmtNum(linesRead)} lines processed`;
  }

  async function readDelta(s,maxBytes=kb(256)){
    if(s.isReading) return null; s.isReading=true;
    try{
      const f=s.fileHandle?await s.fileHandle.getFile():s.file; const size=f.size;
      if(size<s.offset) s.offset=0; if(size===s.offset) return {text:'',size,from:s.offset,to:s.offset};
      const start=Math.max(0,size-maxBytes,s.offset), end=size; const text=await f.slice(start,end).text(); s.offset=size; return {text,size,from:start,to:end};
    }finally{s.isReading=false}
  }

  function startTailingForSource(id){
    const s=sources[id]; if(s.timerId) clearInterval(s.timerId);
    if(!s.live){s.elem.querySelector('.status-text').textContent='Static file (use Refresh)';return;}
    const poll=1200; s.timerId=setInterval(async()=>{
      if(!s.fileHandle) return; lastCheckLabel.textContent=fmtLocal();
      const delta=await readDelta(s,kb(256)); if(!delta||!delta.text) return;
      parsingIndicator.className='pill parsing'; parsingIndicator.textContent='PARSING';
      setTimeout(()=>{parsingIndicator.className='pill active'; parsingIndicator.textContent='ACTIVE'},200);
      s.elem.querySelector('.footer-time').textContent='Last update: '+fmtLocal();

      const lines=delta.text.split(/\r?\n/).filter(Boolean);
      let i=0; const CHUNK=50;
      (function chunk(){ const end=Math.min(i+CHUNK,lines.length);
        for(;i<end;i++){
          const line=lines[i];
          if(!recentLinesCache.has(line)){
            linesRead++; pushToConsole(`[${s.id}] ${line}`);
            parseLine(line,s); // live ‚Üí toasts may fire
            recentLinesCache.add(line); if(recentLinesCache.size>CACHE_SIZE){ const it=recentLinesCache.values().next().value; recentLinesCache.delete(it); }
          }
        }
        if(i<lines.length) setTimeout(chunk, 0);
      })();
      statusMetrics.textContent=`${Object.keys(sources).length} sensor(s) | ${fmtNum(linesRead)} lines processed`;
    },poll);
    modeLabel.textContent='SYSTEM ACTIVE'; parsingIndicator.className='pill active'; parsingIndicator.textContent='ACTIVE';
    statusMetrics.textContent=`${Object.keys(sources).length} sensor(s) | ${fmtNum(linesRead)} lines processed`;
  }

  async function loadLastLines(id,{forceScroll=false,updateTickerNow=false}={}){
    const s=sources[id]; if(!s?.file) return;
    try{
      const f=s.fileHandle?await s.fileHandle.getFile():s.file;
      const lines = await readLastLinesFromFile(f, MAX_INITIAL_LINES);

      // Update ticker from historical lines (NO toasts)
      for(const line of lines){ scanForTickerSignals(line); }
      if(updateTickerNow) setTicker(tickerItems());

      let i=0; const CHUNK=50;
      (function chunk(){ const end=Math.min(i+CHUNK,lines.length);
        for(;i<end;i++){ const l=lines[i]; pushToConsole(`[${s.id}] ${l}`); parseLine(l,s); } // parse adds messages; we suppress toasts elsewhere
        if(i<lines.length) setTimeout(chunk, 0);
      })();

      s.offset = f.size;
      s.elem.querySelector('.footer-time').textContent='Last update: '+fmtLocal();
      if(forceScroll){ consoleBox.scrollTop=consoleBox.scrollHeight; chatDisplay.scrollTop=chatDisplay.scrollHeight; }
    }catch(e){ toastErr(e); }
  }

  /* ===== Signals & Notifications ===== */
  function scanForTickerSignals(message){
    // AI 30
    const ai30 = message.match(/ICC planet[- ]wide announcement:\s+(\w+)\s+has been awarded the highest honorary rank/i);
    if(ai30){ tickerData.lastAI30 = `${ai30[1]} reached AI 30!`; }

    // Level 220 ‚Äî quotes (straight/curly) or unquoted, with or without lead-in text
    const lvl220Quoted = message.match(/['\u2018\u2019]([^'\u2018\u2019]+)['\u2018\u2019]\s+has reached enlightenment/i);
    const lvl220Plain  = message.match(/(^|[^\w'-])([\w-]+)\s+has reached enlightenment/i);
    if(lvl220Quoted){
      tickerData.lastLevel220 = `${lvl220Quoted[1]} hit Level 220!`;
    }else if(lvl220Plain){
      const who = lvl220Plain[2];
      if(who && who.toLowerCase() !== 'has'){ tickerData.lastLevel220 = `${who} hit Level 220!`; }
    }

    // Towers
    if(/tower (battle|attack)/i.test(message)){ tickerData.lastTowerBattle = message.substring(0,100); }

    // World boss spawn (variable location)
    const darkBoss = message.match(/A dark creature rises from its slumber in (.+?)\. It will be immortal for (\d+|\w+)\s+minutes\./i);
    if(darkBoss){
      const loc = darkBoss[1].trim(), mins = darkBoss[2];
      tickerData.lastWorldBoss = { text:`Dark Creature at ${loc} (immortal ~${mins}m)`, ts: nowMs() };
    }

    // Hollow Reaper vulnerable
    if(/The Hollow Reaper is no longer immortal\./i.test(message)){
      tickerData.lastWorldBoss = { text:`Hollow Reaper vulnerable ‚Äî engage!`, ts: nowMs() };
    }
  }

  function reactToNotifications(message,channel='',sender=''){
    if(isCombatMessage(channel, message)) return; // no spam toasts

    const body = sanitizeChatMarkup(message).slice(0,160);
    if((channel==='Team' && channelNotify['Team']) || (channel==='Tell Messages' && channelNotify['Tell Messages'])){
      Toasts.push({title:`üîî ${channel}`,body});
    }
    if(channel==='Tell Messages' && sender){
      const key=String(sender||'').toLowerCase();
      if(buddies.has(key)){ Toasts.push({title:`üì® Tell from ${sender}`,body}); }
    }
    const darkBoss = message.match(/A dark creature rises from its slumber in (.+?)\. It will be immortal for (\d+|\w+)\s+minutes\./i);
    if(ruleWorldBosses.checked && darkBoss){
      const loc = darkBoss[1].trim(), mins = darkBoss[2];
      Toasts.push({title:'üêâ World Boss: Dark Creature', body:`Spawned at ${loc} (immortal ~${mins}m).`});
    }
    if(ruleWorldBosses.checked && /The Hollow Reaper is no longer immortal\./i.test(message)){
      Toasts.push({title:'üó°Ô∏è Hollow Reaper', body:'Vulnerable ‚Äî engage!', variant:'success'});
    }
    if(ruleTowers.checked && /tower (battle|attack)/i.test(message)){
      Toasts.push({title:'‚öîÔ∏è Tower Activity',body,variant:'warn'});
    }
    if(ruleWorldBosses.checked){
      if(/tarasque has arrived and will be immortal/i.test(message)){
        Toasts.push({title:'üêâ World Boss: Tarasque',body:'Spawned (immortal ~30m).'});
      }
      if(/tarasque is no longer immortal/i.test(message)){
        Toasts.push({title:'üêâ World Boss: Tarasque',body:'Vulnerable ‚Äî engage!',variant:'success'});
      }
    }
  }

  /* ===== Parsing ===== */
  function parseLine(line,source){
    const m=line.match(/^(\[.*\])(.*)$/);
    if(!m){
      const channel='System', sender='', message=line, time=fmtLocal();
      activeChannels.add(channel); rebuildChannelUIs();
      scanForTickerSignals(message);
      const isSys=true;
      const isCombat = isCombatMessage(channel, message);
      if(globalFilters[channel]!==false && getTileSystemToggle(source.id) && globalShowSystem && (!isCombat || globalShowCombat)){
        addChatMessage(source.elem.querySelector('.location-input').value||'Unknown',
          {channel,time,sender,message,channelColor:'',isSystemMsg:isSys,sourceId:source.id});
      }
      return;
    }
    try{
      const meta=m[1].slice(1,-1), message=m[2].trim();
      const parts=meta.match(/(?:"[^"]*"|[^,]+)/g)||[];
      const channel=(parts[1]||'""').slice(1,-1);
      const senderRaw=(parts[2]||'""').slice(1,-1); const sender=(senderRaw==='""')?'':senderRaw;
      const ts=parseInt(parts[3],10); const time=isFinite(ts)?new Date(ts*1000).toLocaleTimeString():fmtLocal();

      activeChannels.add(channel); rebuildChannelUIs();
      scanForTickerSignals(message);

      const isSys=isSystemLike(channel,sender,message,false);
      const isCombat = isCombatMessage(channel, message);
      const allowSysTile=getTileSystemToggle(source.id);
      const allowSysGlobal=globalShowSystem;

      if ((isSys && (!allowSysTile || !allowSysGlobal)) ||
          (isCombat && !globalShowCombat) ||
          globalFilters[channel]===false) {
        return;
      }

      const known=['System','Team','Tell Messages'].includes(channel);
      const color=known?'':'#ab47bc';
      addChatMessage(source.elem.querySelector('.location-input').value||'Unknown',
        {channel,time,sender,message,channelColor:color,isSystemMsg:isSys,sourceId:source.id});

      // Live-only notifications:
      if(source.live) reactToNotifications(message,channel,sender);
    }catch(e){ /* swallow parse glitches */ }
  }

  /* ===== Search ===== */
  function buildMatcher(q, regex, cs){
    if(!q) return null;
    if(regex){ try{ return new RegExp(q, cs?'g':'gi'); }catch{ return null; } }
    const needle = cs ? q : q.toLowerCase();
    return { needle, cs };
  }
  function quickMatch(msgEl, matcher, isRegex, cs, channelFilter){
    if(channelFilter && msgEl.dataset.channel !== channelFilter) return false;
    const raw = msgEl.querySelector('.chat-content')?.dataset.raw || '';
    if(!matcher) return true;
    if(isRegex){ try{ matcher.lastIndex=0; return !!matcher.exec(raw); }catch{ return false; } }
    const hay = cs ? raw : raw.toLowerCase();
    return hay.indexOf(matcher.needle) !== -1;
  }
  function renderHighlightsInto(contentEl, matcher, isRegex, cs){
    const raw = contentEl.dataset.raw || contentEl.textContent || '';
    contentEl.innerHTML=''; matchRefs=[]; matchIndex=-1;
    if(!matcher){ contentEl.textContent = raw; return 0; }
    if(!isRegex){
      const ndl = matcher.needle; if(!ndl){ contentEl.textContent=raw; return 0; }
      const hay = cs ? raw : raw.toLowerCase();
      let i=0, last=0, hits=0; const frag=document.createDocumentFragment();
      while(true){
        const idx=hay.indexOf(ndl,i); if(idx===-1) break;
        frag.appendChild(document.createTextNode(raw.slice(last,idx)));
        const mark=document.createElement('mark'); mark.className='search-hit'; mark.textContent=raw.slice(idx,idx+ndl.length);
        frag.appendChild(mark); matchRefs.push(mark); hits++; i=idx+ndl.length; last=i;
      }
      frag.appendChild(document.createTextNode(raw.slice(last)));
      contentEl.appendChild(frag); return hits;
    }else{
      let m, last=0, hits=0; const frag=document.createDocumentFragment();
      matcher.lastIndex=0;
      while((m=matcher.exec(raw))){
        const start=m.index, end=start+m[0].length;
        frag.appendChild(document.createTextNode(raw.slice(last,start)));
        const mark=document.createElement('mark'); mark.className='search-hit'; mark.textContent=raw.slice(start,end);
        frag.appendChild(mark); matchRefs.push(mark); hits++; last=end;
        if(m[0].length===0) matcher.lastIndex++;
      }
      frag.appendChild(document.createTextNode(raw.slice(last)));
      contentEl.appendChild(frag); return hits;
    }
  }
  function applySearch(skipScroll=false){
    const q = searchInput.value;
    const regex = searchRegex.checked;
    const cs = searchCase.checked;
    const only = searchOnly.checked;
    const channelFilter = searchChannel.value;

    currentSearch.query=q; currentSearch.regex=regex; currentSearch.cs=cs; currentSearch.only=only; currentSearch.channel=channelFilter;
    currentSearch.matcher = buildMatcher(q, regex, cs);

    matchRefs=[]; matchIndex=-1;
    applyGlobalFilters();

    if(!q){
      document.querySelectorAll('.chat-content').forEach(el=>{ el.textContent = el.dataset.raw || el.textContent; });
      searchCountEl.textContent='0'; searchPosEl.textContent='‚Äî'; return;
    }

    const msgs=[...document.querySelectorAll('.chat-message')];
    let totalHits=0;

    let i=0; const CHUNK=200;
    (function chunk(){
      const end=Math.min(i+CHUNK, msgs.length);
      for(;i<end;i++){
        const msg=msgs[i];
        const content=msg.querySelector('.chat-content'); if(!content) continue;
        const ok = quickMatch(msg, currentSearch.matcher, regex, cs, channelFilter);
        if(only){ msg.style.display = ok ? '' : 'none'; }
        if(msg.style.display!=='none' && ok){
          totalHits += renderHighlightsInto(content, currentSearch.matcher, regex, cs);
        }else{
          content.textContent = content.dataset.raw || content.textContent;
        }
      }
      if(i<msgs.length){ setTimeout(chunk,0); }
      else{
        searchCountEl.textContent=String(totalHits);
        if(totalHits>0){
          matchIndex=0;
          const first=matchRefs[0];
          if(first && !skipScroll) {
            const msg=first.closest('.chat-message');
            const group=msg?.closest('.location-group'); if(group && group.classList.contains('collapsed')) group.classList.remove('collapsed');
            first.scrollIntoView({behavior:'smooth',block:'center'});
          }
          searchPosEl.textContent=`1/${totalHits}`;
        }else{ searchPosEl.textContent='0/0'; }
      }
    })();
  }
  function focusMatch(idx){
    if(!matchRefs.length){ searchPosEl.textContent='0/0'; return; }
    matchIndex=(idx+matchRefs.length)%matchRefs.length;
    const node=matchRefs[matchIndex];
    searchPosEl.textContent=`${matchIndex+1}/${matchRefs.length}`;
    const msg=node.closest('.chat-message');
    if(msg){
      const group=msg.closest('.location-group'); if(group && group.classList.contains('collapsed')) group.classList.remove('collapsed');
      msg.scrollIntoView({behavior:'smooth',block:'center'});
      chatDisplay.scrollTop = msg.getBoundingClientRect().top - chatDisplay.getBoundingClientRect().top + chatDisplay.scrollTop - 100;
    }
  }
  let searchDeb=null;
  searchInput.addEventListener('input',()=>{ clearTimeout(searchDeb); searchDeb=setTimeout(()=>applySearch(false), 140); });
  [searchRegex,searchCase,searchOnly,searchChannel].forEach(el=>el.addEventListener('change',()=>applySearch(true)));
  searchNext.addEventListener('click',()=>{ if(matchRefs.length) focusMatch(matchIndex+1); });
  searchPrev.addEventListener('click',()=>{ if(matchRefs.length) focusMatch(matchIndex-1); });

  /* ===== Appends batching ===== */
  const appendQueue=new Map(); let appendScheduled=false;
  function enqueueAppend(container, el){
    let arr = appendQueue.get(container); if(!arr){arr=[]; appendQueue.set(container,arr);}
    arr.push(el);
    if(!appendScheduled){
      appendScheduled=true;
      requestAnimationFrame(()=>{
        appendQueue.forEach((arr,container)=>{
          const frag=document.createDocumentFragment();
          for(const node of arr) frag.appendChild(node);
          container.appendChild(frag);
          if(autoScroll){
            container.scrollTop=container.scrollHeight;
            chatDisplay.scrollTop=chatDisplay.scrollHeight;
          }
        });
        appendQueue.clear(); appendScheduled=false;
      });
    }
  }

  /* ===== Footer tools wiring ===== */
  btnOpenPanel.addEventListener('click',()=>{bottomPanel.classList.add('open'); bottomPanel.setAttribute('aria-hidden','false')});
  btnClosePanel.addEventListener('click',()=>{bottomPanel.classList.remove('open'); bottomPanel.setAttribute('aria-hidden','true')});
  btnDismissAllToolbar.addEventListener('click',()=>Toasts.dismissAll());
  btnDismissToasts.addEventListener('click',()=>Toasts.dismissAll());

  /* ===== Controls wiring ===== */
  if (btnAddSource) btnAddSource.addEventListener('click', (e) => { e.preventDefault(); createSourceTile(); });
  btnReset.addEventListener('click',()=>{if(confirm('Reset all sensors and logs?')) resetAll();});
  btnSavedLogs.addEventListener('click',()=>{ openSavedModal(); });
  btnFindLogs.addEventListener('click',()=>{ openFinderModal(); });

  autoscrollToggle.addEventListener('change',()=>{autoScroll=autoscrollToggle.checked});
  notifyTeam.addEventListener('change',()=>channelNotify['Team']=notifyTeam.checked);
  notifyTell.addEventListener('change',()=>channelNotify['Tell Messages']=notifyTell.checked);

  globalShowSystemEl.addEventListener('change',()=>{globalShowSystem=globalShowSystemEl.checked; applyGlobalFilters(); if(currentSearch.query) applySearch(true);});
  globalShowCombatEl.addEventListener('change',()=>{globalShowCombat=globalShowCombatEl.checked; applyGlobalFilters(); if(currentSearch.query) applySearch(true);});

  buddyAddBtn.addEventListener('click',()=>{addBuddy(buddyInput.value); buddyInput.value=''; buddyInput.focus();});
  buddyInput.addEventListener('keydown',(e)=>{if(e.key==='Enter'){addBuddy(buddyInput.value); buddyInput.value='';}});

  /* ===== Finder modal ===== */
  function openFinderModal(){ finderModal.style.display='flex'; }
  finderClose.addEventListener('click',()=>{ finderModal.style.display='none'; });
  finderBrowse.addEventListener('click',()=> finderFile.click());
  finderFile.addEventListener('change', async ()=>{
    const f = finderFile.files[0]; if(!f) return;
    const id = createSourceTileReturnId();
    await addFileToSource(id, f, null);
    finderModal.style.display='none';
  });
  function createSourceTileReturnId(){ createSourceTile(); return 'sensor-'+tileCounter; }

  /* ===== Saved Logs (IndexedDB of file handles) ===== */
  const DB_NAME='oracleFS', DB_VER=1, STORE='files';
  let db=null;
  function idbOpen(){
    return new Promise((resolve,reject)=>{
      const req=indexedDB.open(DB_NAME, DB_VER);
      req.onupgradeneeded=()=>{ const d=req.result; if(!d.objectStoreNames.contains(STORE)) d.createObjectStore(STORE,{keyPath:'id'}); };
      req.onsuccess=()=>resolve(req.result);
      req.onerror=()=>reject(req.error);
    });
  }
  async function getDB(){ if(!db) db=await idbOpen(); return db; }
  async function idbPut(record){
    const d=await getDB(); return new Promise((res,rej)=>{ const tx=d.transaction(STORE,'readwrite'); tx.objectStore(STORE).put(record); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); });
  }
  async function idbAll(){
    const d=await getDB(); return new Promise((res,rej)=>{ const tx=d.transaction(STORE,'readonly'); const st=tx.objectStore(STORE); const out=[]; st.openCursor().onsuccess=e=>{ const c=e.target.result; if(c){ out.push(c.value); c.continue(); }else{ res(out); } }; tx.onerror=()=>rej(tx.error); });
  }
  async function idbDel(id){
    const d=await getDB(); return new Promise((res,rej)=>{ const tx=d.transaction(STORE,'readwrite'); tx.objectStore(STORE).delete(id); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); });
  }
  async function idbClear(){
    const d=await getDB(); return new Promise((res,rej)=>{ const tx=d.transaction(STORE,'readwrite'); tx.objectStore(STORE).clear(); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); });
  }

  async function pickFileHandle(){
    try{
      const [h] = await window.showOpenFilePicker({ types:[{description:'Text logs', accept:{'text/plain':['.txt']}}] });
      return h;
    }catch{ return null; }
  }

  async function saveTileToDB(id){
    try{
      if(!supportsFS){ toastErr('This browser cannot persist file access; you can still use Saved Logs with Browse.'); return; }
      const s=sources[id]; if(!s) return;
      const label = s.label || s.elem.querySelector('.location-input').value.trim() || `Sensor ${id}`;
      let handle = s.fileHandle;
      if(!handle){ handle = await pickFileHandle(); if(!handle) return; const f=await handle.getFile(); await addFileToSource(id,f,handle); }
      const rec={ id:`${Date.now()}-${Math.random().toString(16).slice(2)}`, label, handle };
      await idbPut(rec);
      Toasts.push({title:'Saved', body:`Saved log ‚Äú${label}‚Äù`, variant:'success', timeout:2500});
    }catch(e){ toastErr(e); }
  }

  async function openSavedModal(){
    savedModal.style.display='flex';
    await renderSavedList();
  }
  async function renderSavedList(){
    savedList.textContent='';
    if(!supportsFS){
      const info=document.createElement('div');
      info.style.color='#aab4bf'; info.style.margin='6px 0 10px 0';
      info.textContent='Your browser cannot persist file handles. Use ‚ÄúLog Finder‚Äù or drop the file, then Save will be available in Chromium-based browsers.';
      savedList.appendChild(info);
      return;
    }
    const rows=await idbAll();
    if(rows.length===0){
      const empty=document.createElement('div'); empty.style.color='#aab4bf'; empty.textContent='No saved logs yet.';
      savedList.appendChild(empty); return;
    }
    rows.forEach(row=>{
      const el=document.createElement('div'); el.className='saved-item';
      const left=document.createElement('div');
      left.innerHTML=`<strong>${row.label}</strong><div class="path">[persistent file handle]</div>`;
      const right=document.createElement('div'); right.style.display='flex'; right.style.gap='6px';
      const load=document.createElement('button'); load.className='btn'; load.textContent='Load';
      load.onclick=async()=>{
        try{
          const perm = await row.handle.requestPermission({mode:'read'});
          if(perm!=='granted'){ toastErr('Permission denied for saved file.'); return; }
          const file=await row.handle.getFile();
          createSourceTile(); const id='sensor-'+tileCounter;
          sources[id].label = row.label; sources[id].elem.querySelector('.location-input').value = row.label;
          await addFileToSource(id,file,row.handle);
        }catch(e){ toastErr(e); }
      };
      const del=document.createElement('button'); del.className='btn'; del.textContent='Delete';
      del.onclick=async()=>{ await idbDel(row.id); await renderSavedList(); };
      right.appendChild(load); right.appendChild(del);
      el.appendChild(left); el.appendChild(right);
      savedList.appendChild(el);
    });
  }
  savedClose.addEventListener('click',()=>{ savedModal.style.display='none'; });
  savedPurge.addEventListener('click',async()=>{ if(confirm('Delete all saved logs?')){ await idbClear(); await renderSavedList(); } });

  /* ===== Reset / Boot ===== */
  function resetAll(){
    Object.values(sources).forEach(s=>{s.isReading=false; s.timerId&&clearInterval(s.timerId)});
    Object.keys(sources).forEach(id=>sources[id].elem&&sources[id].elem.remove());
    for(const k in sources) delete sources[k];
    linesRead=0; tileCounter=0; recentLinesCache.clear(); activeChannels.clear();
    rebuildChannelUIs(); modeLabel.textContent='SYSTEM IDLE'; lastCheckLabel.textContent='‚Äî';
    parsingIndicator.className='pill idle'; parsingIndicator.textContent='IDLE';
    statusMetrics.textContent=''; chatDisplay.innerHTML='<div style="color:var(--text-secondary)">(Decrypted comms from active sensors will appear here)</div>';
    consolePre.textContent='(Raw log lines will appear here)';
    tickerData.lastTowerBattle=tickerData.lastLevel220=tickerData.lastAI30=tickerData.lastWorldBoss=null;
    setTicker(tickerItems());
    sourcesList.scrollTop=sourcesList.scrollHeight;

    autoscrollToggle.checked=true; autoScroll=true;
    globalShowSystemEl.checked=true; globalShowSystem=true;
    globalShowCombatEl.checked=false; globalShowCombat=false;
    ruleTowers.checked=true; ruleWorldBosses.checked=true;

    searchInput.value=''; searchOnly.checked=false; searchRegex.checked=false; searchCase.checked=false; searchChannel.value='';
    searchCountEl.textContent='0'; searchPosEl.textContent='‚Äî'; matchRefs=[]; matchIndex=-1; currentSearch.matcher=null;

    updateDismissToolbar();
  }

  document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
      document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active')); document.getElementById(btn.dataset.tab).classList.add('active');
    });
  });

  // Init
  resetAll(); rebuildChannelUIs(); setTicker(tickerItems());
})();
</script>
</body>
</html>
